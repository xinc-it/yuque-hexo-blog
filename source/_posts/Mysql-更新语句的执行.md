---
title: Mysql-更新语句的执行
date: '2022/9/6 12:17:06'
updated: '2023-01-14 16:02:16'
categories: 数据库
tags:
  - Mysql
  - 数据库
  - InnoDB
---
## 1. 更新语句执行流程
![](/images/dcd3497e8365bdada08e90815d583d9a.png)



```bash
mysql> update T set c=c+1 where ID=2;
```

1. 客户端通过连接器连接MySQL 服务器
2. 将缓存中相关表的结果清空
3. 分析器通过词法和语法分析判断是更新语句
4. 优化器通过索引，决定使用ID的索引
5. 执行器执行更新语句
6. 进行redo log 和bin log的修改







## 2.Redo log(引擎日志)


情景老板记账：先把借帐和还账记录写在黑板上，空闲时，再把黑板上账的写入到账本中。



作用： 用作数据库写入将数据磁盘的缓存，防止每次更新都要将数据写进磁盘，提高了更新效率。











![](/images/c2b9e4e942d3e6499168deac006161b2.png)







### 1.  WAL (Write-Ahead Logging) 
**<font style="color:#F5222D;background-color:#FADB14;">先写日志，再写磁盘</font>**。

InnoDB引擎会把记录写道redo log中，并更新内存。然后更新就算完成。引擎会在空闲时间操作记录

写入磁盘。

如果redo log写满了，会把一部分记录更新到磁盘中。

通过write pos 和check point 两个指针来判断日志是否写满



### 2. crash-safe
当数据库发生异常时，可以通过redo log 可以获取到之前的提交记录。

通过提交记录可以将未同步到数据库中数据同步到数据库中。



**<font style="color:#F5222D;">redo log存储的是物理变更日志，用于记录磁盘中指定地方的数值修改记录。</font>**





### 3. 特点


1.  存储的物理日志（记录的是数据页上数据的更改）
2. 先写日志，后写磁盘
3. 可以crash safe 进行数据的修复
4. InnoDB引擎层日志
5. 空间有限会用完，通过队列的实现循环写



## 3. binlog（Server 层日志）
### 1. 特点
1. 服务层日志
2. 存储的内容是逻辑日志（记录的是语句的原始逻辑）
3. 空间无限，通过新增文件实现追加写





## 4. 执行流程




1. 执行引擎先找到ID=2的这一行数据，如果内存中存在直接返回给执行器，否则从磁盘读入内存然后返回给执行器
2. 把值加上1，然后调用引擎接口写入数据
3. 引擎会将新数据更新到内存中，同时更新到redo log中。redo log处于prepare状态，告诉执行器完成了，可以提交事务了。
4. 执行器生成更新操作的bin log,并把bin log写入磁盘
5. 执行器调用引擎的事务接口，将写入的redo log 改成commit状态

![](/images/897e7f677c9a44600b3e9930d8f62fe1.png)



## 5. 两阶段提交


![](/images/d28bd323e4cf3367dc66343e951e25d1.png)



****

**原因**

1. 如果发生crash导致系统崩溃的话，如果顺序不一致，可能导致之后无法通过binlog恢复到任一时刻的数据
2. 可能导致binlog和redo log的数据不一致导致数据冲突。



## 6. 两种日志的不同点
1. redo log 是 InnoDB引擎特有的，binlog是MySQL的Server层实现的
2. redo log 是物理日志，记录的是  **在某个数据页上做了修改**，binlog是逻辑日志记录的是语句逻辑 **给ID=2的数据进行加1**
3. redo log 是循环写，空间大小固定。bin log 是追加写，当bin log文件到达一定大小后会切换到下一个，不会覆盖以前的日志







## 7. 小结
1. 更新语句的执行流程
2. Redo log 的作用是用来存储MySQL产生更新语句的物理日志。通过WAL 技术先将日志写入 队列中然偶后通过指定条件写入磁盘中
3. bin log的作用和特点
4. 两种日志的不同点
5. 两阶段提交的作用
    1. 保证数据库的数据不冲突

